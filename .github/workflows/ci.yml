name: MathOCR Integrity Check

on:
  push:
    branches: [ "main", "develop" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
      with:
        lfs: true  # Git LFSãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ•ã‚§ãƒƒãƒã™ã‚‹è¨­å®š

    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        # ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆè»½é‡åŒ–ã®ãŸã‚torchã¯CPUç‰ˆã‚’æŒ‡å®šã‚‚å¯ã ãŒã€requirementsã«å¾“ã†ï¼‰
        pip install -r requirements.txt
        # ãƒ†ã‚¹ãƒˆç”¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒª
        pip install pytest

    - name: Verify Asset Integrity
      run: |
        # é‡ã¿ãƒ•ã‚¡ã‚¤ãƒ«ã‚„è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹ã‹ã€ã‚µã‚¤ã‚ºãŒ0ã§ãªã„ã‹ç¢ºèª
        if [ ! -s assets/weights.pth ]; then
          echo "Error: assets/weights.pth is missing or empty."
          exit 1
        fi
        if [ ! -s assets/settings.yaml ]; then
          echo "Error: assets/settings.yaml is missing or empty."
          exit 1
        fi
        echo "âœ… Asset Integrity Check Passed"

    - name: Run Model Initialization Test (Dry Run)
      # GPUãªã—ç’°å¢ƒã§ã‚‚å®Ÿè¡Œå¯èƒ½ãªãƒ†ã‚¹ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½œæˆãƒ»å®Ÿè¡Œ
      run: |
        python -c "
        import sys
        import os
        from src.loader import RobustLatexOCR
        
        try:
            print('ğŸš€ Starting Dry-Run Initialization...')
            # ã‚¢ã‚»ãƒƒãƒˆãƒ‘ã‚¹ã‚’æŒ‡å®š
            asset_dir = os.path.join(os.getcwd(), 'assets')
            
            # ãƒ¢ãƒ‡ãƒ«ãƒ­ãƒ¼ãƒ€ãƒ¼ã®åˆæœŸåŒ–ãƒ†ã‚¹ãƒˆ
            # ã“ã“ã§ TypeError ãŒå‡ºã‚Œã°CIã¯è½ã¡ã‚‹
            loader = RobustLatexOCR(asset_dir)
            
            print('âœ… Model initialized successfully!')
            
            # Configã®ä¸­èº«æ¤œè¨¼
            if isinstance(loader.config.max_dimensions, list):
                print('âœ… Config validation passed: max_dimensions is list')
            else:
                sys.exit('âŒ Config validation failed')
                
        except Exception as e:
            print(f'âŒ Test Failed: {e}')
            sys.exit(1)
        "
